# 燕云十六声百业战指挥工具 PRD

## 1. 背景与目标
- 痛点1：指挥无法实时掌握各角色技能冷却，只能通过语音确认，效率极低。
- 痛点2：治疗与陌刀需要按既定顺序轮放大招，一旦有人提前施放就会造成连锁混乱。
- 目标：提供一个极简、可钉在屏幕侧边的 HTML/Electron 工具，让所有参战成员的关键技能 CD 和释放顺序实时可视化，并通过 Supabase Realtime 实现秒级同步。

## 2. 用户与场景
- 指挥官：负责统筹团队技能、野区资源，以拖拽调整优先级、触发全局指令。
- 治疗、陌刀、扇子：关注本组轮转顺序与自身 CD，需在施放大招时一键同步。
- 打野：仅需登记姓名供指挥确认，不参与技能排班面板。
- 使用场景：百业战前准备（组队、设定键位）、战斗进行时（查看顺序、重排、提醒）、战后复盘（查看技能使用记录草稿）。

## 3. 体验总览
- 首页：姓名输入 + 角色按钮（指挥/治疗/陌刀/扇子/打野），保留最近一次设置。点击后进入对应视图。
- 固定地图面板：窗口可缩放，默认 16:9，支持锁定为置顶半透明覆盖屏幕边缘，适配 1080p/2K/超宽屏（最小宽 320px）。
- 主面板默认宽度 720px，可贴合屏幕侧边使用，地图面板以悬浮方式驻留右下角，锁定后自动贴边置顶。
- 非指挥视图压缩至 320px 以内的窄栏模式，只保留竖向技能栏与核心操作，不再展示地图面板。
- 全局配色：指挥面板显示三类技能组（治疗绿色、陌刀棕黄、扇子蓝），打野隐去。

## 4. 功能需求
### 4.1 首页
- 文案极简：顶部放 LOGO/标题，下方是姓名输入框（必填），下方单行列出角色按钮。
- 角色按钮支持键盘快捷键（1-5），选中后立即导航，Supabase 中注册用户状态。

### 4.2 指挥界面
- 结构：
  - 顶部控制区：展示战斗计时、野区刷新、全局操作按钮，横向布局并根据窗口宽度自动换行。
  - 下方分组列：治疗、陌刀、扇子三个分组纵向排列成员卡片，卡片显示：姓名、当前 CD（秒）、状态标签（`就绪`/`冷却`/`提前释放`）。
  - 操作按钮：`战斗开始`/`战斗停止`、`全员技能CD减半`、`重置全部CD` 均位于顶部控制区，触发后立即广播同步。
- 拖拽排序：按住卡片即可在组内拖动；拖动完成后即时写入 Supabase，所有客户端同步。
- 自动排序逻辑：默认按初始顺序循环；当某人上报“已释放”时，系统将其移动到队尾并重置下一次预估 CD。
- 提醒机制：野区刷新每 5 分钟一次，倒计时剩余 1 分钟时弹出高亮提醒，并播放轻量提示音（可静音）。

### 4.3 治疗/陌刀/扇子界面
- 只显示本职业组：当前轮次列表（含自己）与“下一个施放者”高亮条。
- 顶部显示自身信息：姓名、绑定大招按键、当前 CD 倒计时。
- 按钮区域：
  - `绑定大招按键`：点击后进入监听状态（提示用户在 5 秒内按键），在 `app/hooks` 中管理，写入 Supabase `key_bindings` 表并缓存到本地；绑定成功后会自动注册全局快捷键，即便应用失焦也能捕获输入。
  - `大招已释放`：或监听到绑定按键后自动触发，调用 Supabase 函数更新 CD（治疗 80s、陌刀120s、扇子90s）。
  - `误触/重置CD`：二次确认后将自身状态回滚为就绪。
- UI 提示：显示下一位施法者姓名 + 倒计时，若系统检测到队列内有人提前释放（即队列中非当前人上报），则向组内推送提醒条并重新排序。
- 视觉布局：以类似《英雄联盟》技能栏的正方形冷却图标呈现成员状态，竖向堆叠，支持高亮“NEXT”、键位提示与冷却圆环遮罩。

### 4.4 打野界面
- 显示倒计时与提醒（了解野区刷新），无技能列表。
- 可查看指挥发出的公共通知（例如“准备抢野区”）。

### 4.5 记录与历史
- 当战斗停止时，将本场技能释放顺序、时间戳保存为一条 `battle_logs` 记录，供后续导出或复盘（v2 功能，可选）。

## 5. 数据与技术
- Supabase Realtime 频道：`sessions:{sessionId}`，广播事件包括 `cooldown_update`、`order_change`、`timer_state`。
- 数据表建议：
  - `profiles`：`id`、`name`、`role`、`created_at`。
  - `sessions`：`id`、`name`、`status`、`created_by`、`started_at`、`ended_at`。
  - `session_participants`：`session_id`、`profile_id`、`role`、`order_index`、`key_binding`。
  - `cooldowns`：`session_id`、`profile_id`、`skill_type`、`cooldown`、`last_trigger_at`。
  - `battle_logs`（可选）：`session_id`、`entry` JSON、`created_at`。
- 主进程 (`lib/main`) 负责窗口尺寸锁定、置顶和托盘菜单；渲染进程 (`app/`) 通过 Supabase JS SDK 连接 Realtime，并使用 Conveyor 做 IPC（如系统提示音、托盘提醒）。
- 键位监听：在 `lib/preload` 暴露安全 API，利用 `window.addEventListener('keydown')` 捕获焦点内按键；在用户切换出应用时提示重新聚焦。

## 6. 交互与布局细节
- 指挥界面控制卡片位于顶部，按钮高度 40-44px，保留状态色（开始=绿色，停止=红色，减半=橙色），关键操作需二次确认。
- 倒计时信息集中在控制卡片内，显示战斗计时、野区刷新与提醒标识。
- 成员卡片保持 200-220px 宽度，自适应高度，包含姓名、冷却进度条和“Next”徽标。
- 非指挥界面限制宽度 ≤ 320px，成员以竖向技能图标呈现，并在图标上下展示键位与冷却数值。
- 地图面板默认悬浮在右下角，仅在指挥界面显示，锁定后贴边置顶并降低透明度，可通过滑块调整尺寸与透明度。

## 7. 非功能需求
- Realtime 延迟要求 < 500ms；指挥拖拽后 1 秒内全员同步。
- 离线/重连：若网络闪断，保留本地状态并在恢复后推送差异（基于 `updated_at` 时间戳进行冲突解决，指挥端优先级最高）。
- 安全：不读取游戏内存，不注入游戏进程，仅监听应用内按键；提醒用户保持窗口焦点。
- 国际化：初期仅中文，文案在 `app/locales` 可扩展。
- 无障碍：颜色对比度 > 4.5，提供文字标签，提示音可关闭。

## 8. 指标与验证
- 关键指标：
  - 战斗中语音确认次数减少 ≥ 60%。
  - 技能释放顺序错误次数 < 1 次/战。
  - 首屏加载 < 1.5s。
- 可用性验证：邀请 1 名资深指挥 + 6 名成员进行实战测试，收集指挥面板易用性评分（≥8/10）。

## 9. 迭代路线
- v1：基础 CD 同步、顺序拖拽、倒计时提醒、按键监听。
- v1.1：战斗记录导出、群体提醒配置、自定义技能冷却。
- v2：移动端 Web 观战版、语音播报提示、与外部战报系统对接。

## 10. 风险与待确认
- Supabase 连接稳定性（需预设退化方案，如本地广播）。
- 按键监听在全屏游戏下的焦点问题，可能需 Electron 全局快捷键（风险：误触）。
- 地图资源版权与尺寸（需确认官方素材是否可用）。
- 是否需要登陆/鉴权以区分不同战队数据。
